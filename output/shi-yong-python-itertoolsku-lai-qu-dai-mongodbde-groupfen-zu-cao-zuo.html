<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>使用python itertools库来取代mongodb的group分组操作.</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">hackrole's note </a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/shi-yong-python-itertoolsku-lai-qu-dai-mongodbde-groupfen-zu-cao-zuo.html" rel="bookmark"
           title="Permalink to 使用python itertools库来取代mongodb的group分组操作.">使用python itertools库来取代mongodb的group分组操作.</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-01-08T15:40:50+08:00">
                Published: 五 08 一月 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> <a href="/tag/mongodb.html">mongodb</a> <a href="/tag/db_group.html">db_group</a> </p>
</footer><!-- /.post-info -->      <p>最近写项目用到mongodb数据库。后续要做后台管理的时候，有一个需要按（天/人）做聚合的需求(group_by)。</p>
<p>最开始实现上用bson.code.Code配置mongodb自带的group命令做的。不过问题很多。</p>
<div class="section" id="group">
<h2>使用group命令的问题</h2>
<ol class="arabic simple">
<li>必须在python里混合编写js函数。</li>
<li>调试起来及其麻烦, 真心麻烦。</li>
<li>可扩展可维护行差，今天想按天，明天突然有想按月，或者就是要增加聚合字段或是修改聚合算法的规则。</li>
</ol>
<ul class="simple">
<li>使用python的itertools实现</li>
</ul>
<p>后来也是和一朋友讨论后，决定用python itertools来实现.</p>
<p>总的思路就是把数据先查出来，然后在python里自己做聚合.
正好可以配合itertools提供的轮子简化下过程.</p>
<p>** 好处</p>
<ol class="arabic simple">
<li>只用写python代码, 避免混和js的麻烦.</li>
<li>调试方便.</li>
<li>写单元测试也方便很多，不在需要依赖外部的mongodb数据库.</li>
<li>可扩展和可维护行好了很多，因为全是python集合的操作，看着改就可以了。</li>
</ol>
</div>
<div class="section" id="id1">
<h2>坏处或可能的问题</h2>
<p>1) 内存有可能会出问题.
一次查处所有数据，在内存在分组。并且使用python，内存一定要考虑下。</p>
<p>2) mongodb一次查处所有数据遍历有可能碰到的游标中断，数据量太大导致mongodb抛出异常
虽然mongodb有游标的概念, 不过不太确定游标能否正确遍历大数据集合。会不会被异常中断</p>
<ol class="arabic simple" start="3">
<li>性能会相对差一些，不过由于后台不是频繁跑，而且对速度要其也不是太高，所以不算大问题.</li>
</ol>
</div>
<div class="section" id="id2">
<h2>大致思路</h2>
<ol class="arabic simple">
<li>使用itertools.groupby把列表转化为 k-&gt; groups(list)格式的字典.</li>
<li>使用两层循环做聚合操作，第二层循环可以考虑使用reduce/map函数处理.</li>
<li>最后要记得对结果做排序，使用sorted排序，OrderedDict来保存排序结果。</li>
</ol>
</div>
<div class="section" id="id3">
<h2>可能可以考虑的优化</h2>
<p>1) 使用分页遍历防止游标中断或是数据过大的异常.
需要查看groupby是否支持，或能否使用其他方式处理</p>
<ol class="arabic simple" start="2">
<li>如果不是实时的需要显示, 如更新用户的服务书好评率等。可以考虑不使用groupby, 改为居于双层循环的来处理.</li>
</ol>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>