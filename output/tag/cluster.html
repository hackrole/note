<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>hackrole's note - cluster</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">hackrole's note </a></h1>
                <nav><ul>
                    <li><a href="/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/redisji-qun-jiao-cheng-zheng-li.html">redis集群教程整理</a></h1>
<footer class="post-info">
        <abbr class="published" title="2015-12-30T00:00:00+08:00">
                Published: 三 30 十二月 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/redis.html">redis</a> <a href="/tag/redis-cluster.html">redis-cluster</a> <a href="/tag/cluster.html">cluster</a> <a href="/tag/high-avaliable.html">high-avaliable</a> </p>
</footer><!-- /.post-info --><p>redis集群相关内容, 讲解如何设置集群，对集群做测试和常规操作。
不涵盖redis集群的细节，只从用户的角度讲如何使用redis集群, 以及redis的高可用性和一致性相关内容。
更具体内容参见:</p>
<pre class="literal-block">
http://redis.io/topics/cluster-spec
</pre>
<div class="section" id="id1">
<h2>redis集群的作用</h2>
<ol class="arabic simple">
<li>自动把数据分布到多台redis实例上.</li>
<li>再部分节点失败后，保持可用性。再大多数redis节点失败后,redis集群仍然会失败.</li>
</ol>
</div>
<div class="section" id="redistcp">
<h2>redis集群tcp端口</h2>
<p>redis集群需要所有节点开启两个端口.</p>
<ol class="arabic simple">
<li>normal-port. 如6379. 用于客户端的请求处理。</li>
<li>high-port(normal-port+10000). 如16379.
用于集群内节点间使用2进制协议交换数据，
同时完成节点的错误检测，配置更新，故障转移认证等.</li>
</ol>
<p>确定开启这两个端口，并正确的设置防火墙。不然集群可以无法正常工作.</p>
</div>
<div class="section" id="redisdocker">
<h2>redis集群与docker</h2>
<p>redis集群无法的NAT网络下使用。</p>
<p>配合docker使用时，需要开启docker host-networking-mode. 具体参见docker相关文档。</p>
</div>
<div class="section" id="id2">
<h2>redis集群数据共享方式</h2>
<p>redis集群不是通过一致性hash实现. 而且通过hash-slot概念实现(hash槽)
hash槽实现方式: CRC16(key) % 16384. 所以redis集群最多只能包含16384个实例。
每个redis实例都是复制一部分hash槽。如A: 1-5500. B: 5501-11000
这样的实现方式的好处是可以方便的增加和删除节点。只需将对应的槽做移动</p>
<p>如果一个操作涉及多个key, 只要这些key再同一个hash槽中，redis集群允许这类multi-key操作.
可以通过hash-tag的概念强制一系列键保存到同一个hash槽中。</p>
<p>hash-tag概念, 如果一个key里包含{tag}, 则只是用tag来做hash, 以此保证数据被hash到相同的槽中。
如: foo{bar} never{bar}</p>
</div>
<div class="section" id="id3">
<h2>redis集群的主从模式</h2>
<p>redis的分片配置redis主从复制， 来保证高可用性。</p>
</div>
<div class="section" id="id4">
<h2>数据一致性</h2>
<p>redis集群没法保证数据的一致性。再特定的场景下,redis会丢失部分数据.
主要原因在于redis的异步同步的方式上。这是在性能和一致性上的权衡.</p>
<p>还要注意处理集群分裂的问题. 如一个6节点的集群分裂为两个3节点集群，然后各自工作
导致两边数据不同步的问题.</p>
</div>
<div class="section" id="id5">
<h2>redis集群配置</h2>
<div class="section" id="id6">
<h3>配置参数</h3>
<blockquote id="todo">
pass</blockquote>
<p>cluster-enabled &lt;yes/no&gt;</p>
<p>cluster-config-file &lt;filename&gt;. 用于保存集群状态和节点信息，由集群自动更新。</p>
<p>cluster-node-timeout &lt;milliseconds&gt; 超时时间，超时后认为节点不再可用.</p>
<p>cluster-slave-validity-factor &lt;factor&gt;</p>
<p>cluster-migration-barrier &lt;count&gt;</p>
<p>cluster-require-full-coverage &lt;yes/no&gt;</p>
</div>
<div class="section" id="id7">
<h3>创建和使用redis集群</h3>
<p>一般都需要安装ruby的redis包:</p>
<pre class="literal-block">
gem install redis
</pre>
<p>如果是测试可以使用redis下提供的命令，快速启动集群做测试.如下:</p>
<pre class="literal-block">
1) cd &lt;reids&gt;/utils/utils/create-cluster/

2) read the readme and gem install redis.

3) ./create-cluster start

4) ./create-cluster create.

5) test it now.

6) ./create-cluster stop &amp;&amp; ./create-cluster clean
</pre>
<p>当然最好是自己配置集群环境，这样能学到更多东西, 如下:</p>
<pre class="literal-block">
1) mkdir cluster-test
   cd cluster-test
   mkdir 7000 7001 7002 7003 7004 7005
</pre>
</div>
</div>
                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>