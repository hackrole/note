<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>hackrole's note - python</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">hackrole's note </a></h1>
                <nav><ul>
                    <li><a href="/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/shi-yong-supvisordqu-dai-linuxmo-ren-kai-ji-qi-dong-xiang.html">使用supvisord取代linux默认开机启动项</a></h1>
<footer class="post-info">
        <abbr class="published" title="2016-01-08T15:42:28+08:00">
                Published: 五 08 一月 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> <a href="/tag/supvisord.html">supvisord</a> </p>
</footer><!-- /.post-info --><p>linux做为开发环境, 经常需要安装一些第三方服务。
如mongodb服务器，redis服务器, nginx服务器等.</p>
<p>这些服务器如果是通过apt安装，默认是会开机启动,
并且能够通过sudo /etc/init.d/&lt;name&gt; restart/stop/start来控制.
不然就要自己写启动脚本，相当麻烦，并且危险.
并且没法检测到经常意外挂掉，日志和通知也相对较弱.</p>
<p>所以这里考虑用supervisord取代系统的开机启动任务.开机启动supervisor.
由supervisor来启动后续进程。好处多多.</p>
<ol class="arabic simple">
<li>配置文件简单，改起来容易。可控制行强.</li>
<li>自动重启功能。</li>
<li>良好的日志和通知功能。</li>
</ol>
<p>需要注意的事项:</p>
<ol class="arabic simple">
<li>如果应用其他地方也需要启动supervisord，如启动一个web服务器的supervisord进程.
则系统中会有两个supervisor进程。需要注意不引发问题.</li>
<li>supervisord默认有自动重启，会导致通过kill杀掉的进程自动重启，需要注意。
通过supervisorctl -c config stop &lt;NAME&gt;可以用来停止和启动，使用linux别名简化输入.</li>
<li>考虑是否用可能有些进程不适合或不能用supervisor来操作.</li>
<li>如何处理日志通知等也需要考虑.</li>
<li>通过apt-get安装的应用需要先去掉系统中的启动项。</li>
</ol>
                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/shi-yong-python-itertoolsku-lai-qu-dai-mongodbde-groupfen-zu-cao-zuo.html" rel="bookmark"
                           title="Permalink to 使用python itertools库来取代mongodb的group分组操作.">使用python itertools库来取代mongodb的group分组操作.</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-01-08T15:40:50+08:00">
                Published: 五 08 一月 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> <a href="/tag/mongodb.html">mongodb</a> <a href="/tag/db_group.html">db_group</a> </p>
</footer><!-- /.post-info -->                <p>最近写项目用到mongodb数据库。后续要做后台管理的时候，有一个需要按（天/人）做聚合的需求(group_by)。</p>
<p>最开始实现上用bson.code.Code配置mongodb自带的group命令做的。不过问题很多。</p>
<div class="section" id="group">
<h2>使用group命令的问题</h2>
<ol class="arabic simple">
<li>必须在python里混合编写js函数。</li>
<li>调试起来及其麻烦, 真心麻烦。</li>
<li>可扩展可维护行差，今天想按天，明天突然有想按月，或者就是要增加聚合字段或是修改聚合算法的规则。</li>
</ol>
<ul class="simple">
<li>使用python的itertools实现</li>
</ul>
<p>后来也是和一朋友讨论后，决定用python itertools来实现.</p>
<p>总的思路就是把数据先查出来，然后在python里自己做聚合.
正好可以配合itertools提供的轮子简化下过程.</p>
<p>** 好处</p>
<ol class="arabic simple">
<li>只用写python代码, 避免混和js的麻烦.</li>
<li>调试方便.</li>
<li>写单元测试也方便很多，不在需要依赖外部的mongodb数据库.</li>
<li>可扩展和可维护行好了很多，因为全是python集合的操作，看着改就可以了。</li>
</ol>
</div>
<div class="section" id="id1">
<h2>坏处或可能的问题</h2>
<p>1) 内存有可能会出问题.
一次查处所有数据，在内存在分组。并且使用python，内存一定要考虑下。</p>
<p>2) mongodb一次查处所有数据遍历有可能碰到的游标中断，数据量太大导致mongodb抛出异常
虽然mongodb有游标的概念, 不过不太确定游标能否正确遍历大数据集合。会不会被异常中断</p>
<ol class="arabic simple" start="3">
<li>性能会相对差一些，不过由于后台不是频繁跑 ...</li></ol></div>
                <a class="readmore" href="/shi-yong-python-itertoolsku-lai-qu-dai-mongodbde-groupfen-zu-cao-zuo.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/pythonzhong-shi-yong-withlai-jian-shao-dai-ma-zhong-fu.html" rel="bookmark"
                           title="Permalink to python中使用with来减少代码重复">python中使用with来减少代码重复</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-01-08T15:36:07+08:00">
                Published: 五 08 一月 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> </p>
</footer><!-- /.post-info -->                <div class="section" id="python-with">
<h2>python with的执行流程</h2>
<pre class="literal-block">
#+BEGIN_SRC python
with &lt;context&gt; as &lt;v&gt;:
    &lt;do things or raise Exception&gt;
#+END
</pre>
<p>with &lt;context&gt; as v:</p>
<ol class="arabic simple">
<li>先加载__exit__函数，如果context里没有实现，会在这里报错的</li>
<li>执行__enter__方法,并把结果传给v</li>
<li>执行用户代码,如果正常推出,使用(None, None, None)调用__exit__,
如果代码抛出异常，使用(type, exception, traceback)调用__exit__</li>
</ol>
<p>由上可以看出通过在代码里抛出特定异常，在__exit__里在下异常检测，
可以实现重用户代码向__exit__传递参数的作用.</p>
</div>
<div class="section" id="id1">
<h2>例子</h2>
<pre class="literal-block">
#+BEGIN_SRC python


#+END
</pre>
</div>

                <a class="readmore" href="/pythonzhong-shi-yong-withlai-jian-shao-dai-ma-zhong-fu.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/pythonshu-ju-fen-xi-twitterxiang-guan.html" rel="bookmark"
                           title="Permalink to python数据分析twitter相关">python数据分析twitter相关</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-01-08T15:35:14+08:00">
                Published: 五 08 一月 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> <a href="/tag/data_analizer.html">data_analizer</a> <a href="/tag/social_data.html">social_data</a> </p>
</footer><!-- /.post-info -->                <p>twitter提供了一系列的api使得可以通过api来分析twitter数据，获取最热话题等.
主要用于社交化数据分析. python端有python-twitter模块包装了常用的twitter api.</p>
<div class="section" id="id1">
<h2>代理问题</h2>
<p>国内由于长城网的关系，twitter被屏蔽. python-twitter也没法使用.
所幸最近看issues, 代理问题是否已经有其他的commit解决，并合并.</p>
<p>使用export http_proxy环境变量的方式来使用.</p>
</div>
<div class="section" id="twitter-python-twitter">
<h2>区分twitter/python-twitter的区别</h2>
<p>twitter是官网放出来的包, python-twitter是github上开源的代码。
有时间比较下两者的区别和优劣.</p>
</div>

                <a class="readmore" href="/pythonshu-ju-fen-xi-twitterxiang-guan.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/dai-ma-feng-ge-tong-gui-fan.html" rel="bookmark"
                           title="Permalink to 代码风格统一规范">代码风格统一规范</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-01-08T00:00:00+08:00">
                Published: 五 08 一月 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> <a href="/tag/pep8.html">pep8</a> <a href="/tag/code.html">code</a> <a href="/tag/style.html">style</a> </p>
</footer><!-- /.post-info -->                <p>代码建议统一使用pep8规范加上部分最佳实践。</p>
<p>风格指南是关于一致性的。风格一致对一个项目更重要。</p>
<p>Guido 的主要洞察力 (key insights) 之一是：代码更多是用来读而不是写。</p>
<p>故本 指南致力于改善 Python 代码的可读性、使不同的 (wide spectrum) Python 代码 保持一致性。</p>
<div class="section" id="pep8">
<h2>pep8规范</h2>
<p>代码pep8规范可以使用python pep8工具做检查.</p>
<p>安装方法:</p>
<pre class="literal-block">
pip install pep8
</pre>
<p>使用方法:</p>
<pre class="literal-block">
pep8 &lt;python文件&gt;
</pre>
<p>一般IDE工具都会有集成，可以在编写代码的工程中做pep8校验. 可自行google设置方法。</p>
<div class="section" id="id2">
<h3>代码布局</h3>
<ol class="arabic">
<li><p class="first">每级缩进用 4 个空格。</p>
</li>
<li><p class="first">建议使用4个空格代替tab,最流行的 Python 缩进方式是仅使用空格</p>
</li>
<li><p class="first">绝不要混合使用 tab 和空格。建议打开IDE中的tab和空格(或至少显示行尾空格)显示。</p>
</li>
<li><p class="first">限制所有行的最大行宽为 79 字符。</p>
<p>折叠长行的首选方法是使用 ...</p></li></ol></div></div>
                <a class="readmore" href="/dai-ma-feng-ge-tong-gui-fan.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/ru-guo-zai-pytestzhong-shi-yong-pdbdiao-shi-dai-ma.html" rel="bookmark"
                           title="Permalink to 如果在pytest中使用pdb调试代码">如果在pytest中使用pdb调试代码</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-11-01T00:00:00+08:00">
                Published: 日 01 十一月 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/pytest.html">py.test</a> <a href="/tag/python.html">python</a> <a href="/tag/pdb.html">pdb</a> <a href="/tag/tdd.html">TDD</a> <a href="/tag/test.html">test</a> </p>
</footer><!-- /.post-info -->                <p class="first last">how to use pdb in py.test</p>

                <a class="readmore" href="/ru-guo-zai-pytestzhong-shi-yong-pdbdiao-shi-dai-ma.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>