<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>hackrole's note - redis</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">hackrole's note </a></h1>
                <nav><ul>
                    <li><a href="/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/redischi-jiu-hua-pei-zhi-xiang-guan.html">redis持久化配置相关</a></h1>
<footer class="post-info">
        <abbr class="published" title="2016-01-08T14:35:13+08:00">
                Published: 五 08 一月 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/redis.html">redis</a> <a href="/tag/redis_persistence.html">redis_persistence</a> <a href="/tag/redischi-jiu-hua.html">redis持久化</a> </p>
</footer><!-- /.post-info --><div class="section" id="id1">
<h2>持久化级别</h2>
<p>redis提供如下四中持久化方案:</p>
<ol class="arabic simple">
<li>完全不持久化，纯内存操作。比如做缓存服务器时。</li>
<li>RDB持久化，配置时间间隔，异步持久化。默认的持久化方案。</li>
<li>AOF持久化，所有操作都是记录到日志文件，保证所有数据都被记录。
在redis重启时，会使用AOF重建数据集。</li>
<li>结合使用RDB和AOF的持久化方案.重启时会使用AOF重建。</li>
</ol>
<div class="section" id="rdb">
<h3>RDB优缺点</h3>
<p>优点:</p>
<ol class="arabic simple">
<li>结构紧凑的文件，相当与系统的实时快照，很适合做数据库备份和灾难恢复。</li>
<li>性能优秀，服务线程不需要处理i/o.</li>
<li>大数据集上重启很快。不需要重建</li>
</ol>
<p>缺点:</p>
<ol class="arabic simple">
<li>间隔性同步到磁盘，导致有可能会丢失部分数据。</li>
<li>fork有可能堵塞导致暂不可用.</li>
</ol>
</div>
<div class="section" id="aof">
<h3>AOF优缺点</h3>
<p>优点:</p>
<ol class="arabic simple">
<li>更加稳定，可以设置为 不同步/每秒同步/完全同步.</li>
<li>redis可以rewrite过大的AOF log.</li>
<li>保存了所有操作，可以从误操作中回复数据库。</li>
</ol>
<p>缺点:</p>
<ol class="arabic simple">
<li>所需的文件通常比RDB更大</li>
<li>查询性能相对比RDB更差。</li>
<li>有很稀有的bug存在，RDB没有此类bug.</li>
</ol>
</div>
</div>
<div class="section" id="id2">
<h2>如何使用</h2>
<ol class="arabic simple">
<li>如果想要更强的数据一致性，则应该组合使用AOF和RDB</li>
<li>如果可以容忍少量的数据丢失,可以只使用RDB.</li>
<li>不推荐只是AOF. RDB可以很好的处理备份和灾难恢复.</li>
</ol>
<p>redis最终会合并两种持久化策略，不过时间比较久</p>
</div>
<div class="section" id="id3">
<h2>其他</h2>
<div class="section" id="id4">
<h3>快照</h3>
<p>默认情况下RDB数据被存到dump.rdb文件下.</p>
<p>可以手动掉 save/bgsave命令调用.</p>
<p>配置保存策略:</p>
<pre class="literal-block">
save &lt;seconds&gt; &lt;keys&gt;
....
</pre>
<p>RDB数据会先写到临时文件，然后替换掉旧的RDB文件.</p>
<!-- TODO:

其他 -->
</div>
</div>
                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/redisfu-wu-guan-li-xu-yao.html" rel="bookmark"
                           title="Permalink to redis服务管理需要">redis服务管理需要</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-01-08T14:34:49+08:00">
                Published: 五 08 一月 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/redis.html">redis</a> </p>
</footer><!-- /.post-info -->                <p>介绍一些redis部署时的注意事项</p>
<div class="section" id="id1">
<h2>注意事项</h2>
<ol class="arabic simple">
<li>建议使用linux部署。</li>
<li>sysctl vm.overcommit_memory=1 或者 vm.overcommit_memory = 1 (/etc/sysctl.conf)</li>
<li>echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</li>
<li>设置一个和内存一样大或更大的swap分区，不然redis有可能在内存不足时被系统杀死。</li>
<li>设置一个明确的maxmemory. 这样redis会在内存到限后抛出错误，而不会falling.</li>
<li>在写比较重的场景下需要有大约2倍于normal的内存。这些是来在内存中保留那些需要被写回磁盘的数据.</li>
<li>配置supervisor类工具时，设置 daemonize no</li>
<li>开启slave特性时，即便不使用持久化特性,redis也会perform RDB save. 除非使用实验性的diskless-sync.</li>
<li>开启slaev特性时，要确保要么开发master节点的保存特性，要么关闭master节点的自动重启。</li>
<li>注意开发redis安全相关配置. require-pass/rewrite-command/bind-ip</li>
</ol>
</div>
<div class="section" id="aws">
<h2>aws注意事项</h2>
<ol class="arabic simple">
<li>使用HWS实例，不要使用pv实例</li>
<li>不要使用太老的实例。 m3 ...</li></ol></div>
                <a class="readmore" href="/redisfu-wu-guan-li-xu-yao.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/redisshu-ju-jie-gou-jie-shao.html" rel="bookmark"
                           title="Permalink to redis数据结构介绍">redis数据结构介绍</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-01-08T14:31:57+08:00">
                Published: 五 08 一月 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/redis.html">redis</a> <a href="/tag/data-type.html">data-type</a> </p>
</footer><!-- /.post-info -->                <p class="first last">redis中string/list/hash/set/sorted-set/bit介绍</p>

                <a class="readmore" href="/redisshu-ju-jie-gou-jie-shao.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/redisfu-zhi-pei-zhi-xiang-guan.html" rel="bookmark"
                           title="Permalink to redis复制配置相关">redis复制配置相关</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-01-08T14:31:05+08:00">
                Published: 五 08 一月 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/redis.html">redis</a> <a href="/tag/redis_slave.html">redis_slave</a> </p>
</footer><!-- /.post-info -->                <p>原内容来自redis官方文档:</p>
<pre class="literal-block">
redis-replication官方文档&lt;http://redis.io/topics/replication&gt;
</pre>
<p>基本来说，只要在配置文件里加上:</p>
<pre class="literal-block">
slaveof &lt;ip&gt; &lt;port&gt;
</pre>
<p>就可以完成配置.</p>
<p>如下配置可能有用:</p>
<pre class="literal-block">
repl-diskless-sync (不使用磁盘同步)
repl-diskless-sync-delay (同步前的延时, 以等待其他的要链接的slave)
</pre>
<div class="section" id="id1">
<h2>安全问题</h2>
<p>如果redis开启复制特性，同时master节点关闭持久化特性。
这时应该避免master节点的自动重启，避免slave节点上的数据被重启的master节点清空。</p>
</div>
<div class="section" id="id2">
<h2>同步策略</h2>
<p>redis默认使用磁盘同步, 数据被存到RDB file文件, 之后通过同步该文件做full-sync.</p>
<p>但是如果磁盘太慢会导致性能不好，2.8新增直接通过socket来同步的方式.(该方式目前仍然是实验阶段)</p>
</div>
<div class="section" id="id3">
<h2>只读复制</h2>
<p>redis默认slave是只读的,所有写操作会报错.
通过如下方式可以打开读写:</p>
<pre class="literal-block">
slave-read-only no (配置文件)
config set slave-read-only no (redis-cli运行时)
</pre>
<p>即便是只读slave也不应该暴露在公网下.
debug/config等命令仍会带来完全问题(使用rename-command配置)</p>
<p>读写slave在较少场景下会有用 ...</p></div>
                <a class="readmore" href="/redisfu-zhi-pei-zhi-xiang-guan.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/redisgao-ke-yong-jian-kong-sentinelpei-zhi-he-shi-yong.html" rel="bookmark"
                           title="Permalink to redis高可用监控sentinel配置和使用">redis高可用监控sentinel配置和使用</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-12-31T00:00:00+08:00">
                Published: 四 31 十二月 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/redis.html">redis</a> <a href="/tag/redis-sentinel.html">redis-sentinel</a> <a href="/tag/high-avaliable.html">high-avaliable</a> </p>
</footer><!-- /.post-info -->                <p class="first last">如何通过配置sentinel实现redis集群高可用</p>

                <a class="readmore" href="/redisgao-ke-yong-jian-kong-sentinelpei-zhi-he-shi-yong.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/redisfen-pian-xiao-ji.html" rel="bookmark"
                           title="Permalink to redis分片小记">redis分片小记</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-12-30T00:00:00+08:00">
                Published: 三 30 十二月 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/redis.html">redis</a> <a href="/tag/partition.html">partition</a> <a href="/tag/redis-partition.html">redis-partition</a> </p>
</footer><!-- /.post-info -->                <p>介绍redis分片相关内容.</p>
<div class="section" id="id1">
<h2>分片相关</h2>
<p>分片是将数据分布到不同的redis实例上, 让每个redis服务实例只保存部分数据。</p>
<div class="section" id="id2">
<h3>为何需要分片</h3>
<ol class="arabic simple">
<li>突破单机的内存和磁盘存储限制.</li>
<li>复用多机的cpu计算和网络传输能力。</li>
</ol>
</div>
<div class="section" id="id3">
<h3>分片方法</h3>
<p>分片有不同的实现方式, 如</p>
<ol class="arabic simple">
<li>范围分片, R0(1-10000), R1(10001-2000)...
缺点: 需要记录键的对应情况，所以比较低效, redis中不建议这种方式.</li>
<li>hash分片. 对每个key通过hash函数，计算到对应的实例。
redis中部分client和proxy实现了一致性hash来做分片处理。</li>
</ol>
</div>
<div class="section" id="id4">
<h3>分片实现层面</h3>
<p>分片可以做不同层面实现.</p>
<ol class="arabic">
<li><p class="first">客户端, 直接在客户端选择正确的实例完成操作。部分redis-client库实现这一功能.</p>
</li>
<li><p class="first">proxy, 类似mogos. 客户端链接到proxy, 由proxy代为转发到正确的redis实例上. 比如twemproxy:</p>
<pre class="literal-block">
https://github.com/twitter/twemproxy
</pre>
</li>
<li><p class="first">查询路由. 查询被发到集群中任一台实例上, 由实例来转发到正确的实例上.
redis集群实现了一个混合风格的查询路由，需要配合client端使用(不是由redis来做定位，而是重定向client来实现).</p>
</li>
</ol>
</div>
<div class="section" id="id5">
<h3>分片的缺点</h3>
<ol class="arabic simple">
<li>跨越多个key的操作通常都不能使用, 部分操作可以通过间接的方式实现.</li>
<li>跨越多个key的事务无法被支持.</li>
<li>XXX ...</li></ol></div></div>
                <a class="readmore" href="/redisfen-pian-xiao-ji.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/redisji-qun-jiao-cheng-zheng-li.html" rel="bookmark"
                           title="Permalink to redis集群教程整理">redis集群教程整理</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-12-30T00:00:00+08:00">
                Published: 三 30 十二月 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hackrole.html">hackrole</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>
<p>tags: <a href="/tag/redis.html">redis</a> <a href="/tag/redis-cluster.html">redis-cluster</a> <a href="/tag/cluster.html">cluster</a> <a href="/tag/high-avaliable.html">high-avaliable</a> </p>
</footer><!-- /.post-info -->                <p>redis集群相关内容, 讲解如何设置集群，对集群做测试和常规操作。
不涵盖redis集群的细节，只从用户的角度讲如何使用redis集群, 以及redis的高可用性和一致性相关内容。
更具体内容参见:</p>
<pre class="literal-block">
http://redis.io/topics/cluster-spec
</pre>
<div class="section" id="id1">
<h2>redis集群的作用</h2>
<ol class="arabic simple">
<li>自动把数据分布到多台redis实例上.</li>
<li>再部分节点失败后，保持可用性。再大多数redis节点失败后,redis集群仍然会失败.</li>
</ol>
</div>
<div class="section" id="redistcp">
<h2>redis集群tcp端口</h2>
<p>redis集群需要所有节点开启两个端口.</p>
<ol class="arabic simple">
<li>normal-port. 如6379. 用于客户端的请求处理。</li>
<li>high-port(normal-port+10000). 如16379.
用于集群内节点间使用2进制协议交换数据，
同时完成节点的错误检测，配置更新，故障转移认证等.</li>
</ol>
<p>确定开启这两个端口，并正确的设置防火墙。不然集群可以无法正常工作.</p>
</div>
<div class="section" id="redisdocker">
<h2>redis集群与docker</h2>
<p>redis集群无法的NAT网络下使用。</p>
<p>配合docker使用时，需要开启docker host-networking-mode. 具体参见docker相关文档。</p>
</div>
<div class="section" id="id2">
<h2>redis集群数据共享方式</h2>
<p>redis集群不是通过一致性hash实现. 而且通过hash-slot概念实现(hash槽)
hash槽实现方式: CRC16(key) % 16384. 所以redis集群最多只能包含16384个实例。
每个redis实例都是复制一部分hash槽 ...</p></div>
                <a class="readmore" href="/redisji-qun-jiao-cheng-zheng-li.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>